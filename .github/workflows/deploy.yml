name: Build and Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install SSH client
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass

      - name: Create .env on VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.VPS_HOST_PORT }} \
            root@${{ secrets.VPS_HOST_ADDRESS }} \
            "mkdir -p /deployment && echo -e 'POSTGRES_USER=${{ secrets.POSTGRES_USER }}\nPOSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}\nPOSTGRES_DB=${{ secrets.POSTGRES_DB }}' > /deployment/.env"

      - name: Build and deploy on VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.VPS_HOST_PORT }} \
            root@${{ secrets.VPS_HOST_ADDRESS }} << 'DEPLOY'

            set -e

            # Clone/update repo
            if [ -d /src/paperassist/.git ]; then
              cd /src/paperassist && git pull origin main
            else
              rm -rf /src/paperassist
              git clone https://github.com/TheDMNMachine/PaperAssist.git /src/paperassist
              cd /src/paperassist
            fi

            # Build Docker images
            docker build -t paperassist-api:latest ./api
            docker build -t paperassist-web:latest ./web

            # Prepare deployment
            cp -r deployment/* /deployment/

            # Fix image names in compose (use local, not ghcr)
            cd /deployment
            sed -i 's|ghcr.io/thedmnmachine/paperassist-api:latest|paperassist-api:latest|g' docker-compose.yml
            sed -i 's|ghcr.io/thedmnmachine/paperassist-web:latest|paperassist-web:latest|g' docker-compose.yml

            # Deploy
            docker compose down
            docker compose up -d

            # Health check
            sleep 10
            curl -sf http://localhost/api/health && echo " API OK" || echo "WARNING: API health check failed"
            curl -sf http://localhost/ > /dev/null && echo "Web OK" || echo "WARNING: Web health check failed"

            docker image prune -f

          DEPLOY
