name: Build and Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SSH client
        run: sudo apt-get update -qq && sudo apt-get install -y -qq sshpass rsync

      - name: Create directories on VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.VPS_HOST_PORT }} \
            root@${{ secrets.VPS_HOST_ADDRESS }} \
            "mkdir -p /src/paperassist /deployment"

      - name: Upload source code to VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p ${{ secrets.VPS_HOST_PORT }}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='.next' \
            --exclude='firmware' \
            --exclude='mobile' \
            ./ root@${{ secrets.VPS_HOST_ADDRESS }}:/src/paperassist/

      - name: Create .env on VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.VPS_HOST_PORT }} \
            root@${{ secrets.VPS_HOST_ADDRESS }} \
            "mkdir -p /deployment && echo -e 'POSTGRES_USER=${{ secrets.POSTGRES_USER }}\nPOSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}\nPOSTGRES_DB=${{ secrets.POSTGRES_DB }}' > /deployment/.env"

      - name: Build and deploy on VPS
        run: |
          sshpass -p "${{ secrets.VPS_HOST_PASSWORD }}" \
            ssh -o StrictHostKeyChecking=no \
            -p ${{ secrets.VPS_HOST_PORT }} \
            root@${{ secrets.VPS_HOST_ADDRESS }} << 'DEPLOY'

            set -e
            cd /src/paperassist

            # Build Docker images on VPS
            docker build -t paperassist-api:latest ./api
            docker build -t paperassist-web:latest ./web

            # Copy deployment config
            cp -r deployment/* /deployment/

            # Update docker-compose to use local images
            cd /deployment
            sed -i 's|ghcr.io/thedmnmachine/paperassist-api:latest|paperassist-api:latest|g' docker-compose.yml
            sed -i 's|ghcr.io/thedmnmachine/paperassist-web:latest|paperassist-web:latest|g' docker-compose.yml

            # Deploy
            docker compose down
            docker compose up -d

            # Wait and health check
            sleep 10
            curl -sf http://localhost/api/health && echo " â€” API OK" || echo "WARNING: API health check failed"
            curl -sf http://localhost/ > /dev/null && echo "Web OK" || echo "WARNING: Web health check failed"

            # Cleanup
            docker image prune -f

          DEPLOY
